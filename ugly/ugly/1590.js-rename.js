const _=require("underscore-plus");const url=require("url");const path=require("path");const{Emitter,Disposable,CompositeDisposable}=require("event-kit");const fs=require("fs-plus");const{Directory}=require("pathwatcher");const Grim=require("grim");const DefaultDirectorySearcher=require("./default-directory-searcher");const RipgrepDirectorySearcher=require("./ripgrep-directory-searcher");const Dock=require("./dock");const Model=require("./model");const StateStore=require("./state-store");const TextEditor=require("./text-editor");const Panel=require("./panel");const PanelContainer=require("./panel-container");const Task=require("./task");const WorkspaceCenter=require("./workspace-center");const{createWorkspaceElement}=require("./workspace-element");const STOPPED_CHANGING_ACTIVE_PANE_ITEM_DELAY=100;const ALL_LOCATIONS=["center","left","right","bottom"];module.exports=class e extends Model{constructor(e){super(...arguments);this.updateWindowTitle=this.updateWindowTitle.bind(this);this.updateDocumentEdited=this.updateDocumentEdited.bind(this);this.didDestroyPaneItem=this.didDestroyPaneItem.bind(this);this.didChangeActivePaneOnPaneContainer=this.didChangeActivePaneOnPaneContainer.bind(this);this.didChangeActivePaneItemOnPaneContainer=this.didChangeActivePaneItemOnPaneContainer.bind(this);this.didActivatePaneContainer=this.didActivatePaneContainer.bind(this);this.enablePersistence=e.enablePersistence;this.packageManager=e.packageManager;this.config=e.config;this.project=e.project;this.notificationManager=e.notificationManager;this.viewRegistry=e.viewRegistry;this.grammarRegistry=e.grammarRegistry;this.applicationDelegate=e.applicationDelegate;this.assert=e.assert;this.deserializerManager=e.deserializerManager;this.textEditorRegistry=e.textEditorRegistry;this.styleManager=e.styleManager;this.draggingItem=false;this.itemLocationStore=new StateStore("AtomPreviousItemLocations",1);this.emitter=new Emitter;this.openers=[];this.destroyedItemURIs=[];this.stoppedChangingActivePaneItemTimeout=null;this.scandalDirectorySearcher=new DefaultDirectorySearcher;this.ripgrepDirectorySearcher=new RipgrepDirectorySearcher;this.consumeServices(this.packageManager);this.paneContainers={center:this.createCenter(),left:this.createDock("left"),right:this.createDock("right"),bottom:this.createDock("bottom")};this.activePaneContainer=this.paneContainers.center;this.hasActiveTextEditor=false;this.panelContainers={top:new PanelContainer({viewRegistry:this.viewRegistry,location:"top"}),left:new PanelContainer({viewRegistry:this.viewRegistry,location:"left",dock:this.paneContainers.left}),right:new PanelContainer({viewRegistry:this.viewRegistry,location:"right",dock:this.paneContainers.right}),bottom:new PanelContainer({viewRegistry:this.viewRegistry,location:"bottom",dock:this.paneContainers.bottom}),header:new PanelContainer({viewRegistry:this.viewRegistry,location:"header"}),footer:new PanelContainer({viewRegistry:this.viewRegistry,location:"footer"}),modal:new PanelContainer({viewRegistry:this.viewRegistry,location:"modal"})};this.incoming=new Map}get paneContainer(){Grim.deprecate("`atom.workspace.paneContainer` has always been private, but it is now gone. Please use `atom.workspace.getCenter()` instead and consult the workspace API docs for public methods.");return this.paneContainers.center.paneContainer}getElement(){if(!this.element){this.element=createWorkspaceElement().initialize(this,{config:this.config,project:this.project,viewRegistry:this.viewRegistry,styleManager:this.styleManager})}return this.element}createCenter(){return new WorkspaceCenter({config:this.config,applicationDelegate:this.applicationDelegate,notificationManager:this.notificationManager,deserializerManager:this.deserializerManager,viewRegistry:this.viewRegistry,didActivate:this.didActivatePaneContainer,didChangeActivePane:this.didChangeActivePaneOnPaneContainer,didChangeActivePaneItem:this.didChangeActivePaneItemOnPaneContainer,didDestroyPaneItem:this.didDestroyPaneItem})}createDock(e){return new Dock({location:e,config:this.config,applicationDelegate:this.applicationDelegate,deserializerManager:this.deserializerManager,notificationManager:this.notificationManager,viewRegistry:this.viewRegistry,didActivate:this.didActivatePaneContainer,didChangeActivePane:this.didChangeActivePaneOnPaneContainer,didChangeActivePaneItem:this.didChangeActivePaneItemOnPaneContainer,didDestroyPaneItem:this.didDestroyPaneItem})}reset(e){this.packageManager=e;this.emitter.dispose();this.emitter=new Emitter;this.paneContainers.center.destroy();this.paneContainers.left.destroy();this.paneContainers.right.destroy();this.paneContainers.bottom.destroy();_.values(this.panelContainers).forEach(e=>{e.destroy()});this.paneContainers={center:this.createCenter(),left:this.createDock("left"),right:this.createDock("right"),bottom:this.createDock("bottom")};this.activePaneContainer=this.paneContainers.center;this.hasActiveTextEditor=false;this.panelContainers={top:new PanelContainer({viewRegistry:this.viewRegistry,location:"top"}),left:new PanelContainer({viewRegistry:this.viewRegistry,location:"left",dock:this.paneContainers.left}),right:new PanelContainer({viewRegistry:this.viewRegistry,location:"right",dock:this.paneContainers.right}),bottom:new PanelContainer({viewRegistry:this.viewRegistry,location:"bottom",dock:this.paneContainers.bottom}),header:new PanelContainer({viewRegistry:this.viewRegistry,location:"header"}),footer:new PanelContainer({viewRegistry:this.viewRegistry,location:"footer"}),modal:new PanelContainer({viewRegistry:this.viewRegistry,location:"modal"})};this.openers=[];this.destroyedItemURIs=[];if(this.element){this.element.destroy();this.element=null}this.consumeServices(this.packageManager)}initialize(){this.originalFontSize=this.config.get("defaultFontSize");this.project.onDidChangePaths(this.updateWindowTitle);this.subscribeToAddedItems();this.subscribeToMovedItems();this.subscribeToDockToggling()}consumeServices({serviceHub:e}){this.directorySearchers=[];e.consume("atom.directory-searcher","^0.1.0",e=>this.directorySearchers.unshift(e))}serialize(){return{deserializer:"Workspace",packagesWithActiveGrammars:this.getPackageNamesWithActiveGrammars(),destroyedItemURIs:this.destroyedItemURIs.slice(),paneContainer:{version:2},paneContainers:{center:this.paneContainers.center.serialize(),left:this.paneContainers.left.serialize(),right:this.paneContainers.right.serialize(),bottom:this.paneContainers.bottom.serialize()}}}deserialize(e,t){const i=e.packagesWithActiveGrammars!=null?e.packagesWithActiveGrammars:[];for(let e of i){const n=this.packageManager.getLoadedPackage(e);if(n!=null){n.loadGrammarsSync()}}if(e.destroyedItemURIs!=null){this.destroyedItemURIs=e.destroyedItemURIs}if(e.paneContainers){this.paneContainers.center.deserialize(e.paneContainers.center,t);this.paneContainers.left.deserialize(e.paneContainers.left,t);this.paneContainers.right.deserialize(e.paneContainers.right,t);this.paneContainers.bottom.deserialize(e.paneContainers.bottom,t)}else if(e.paneContainer){this.paneContainers.center.deserialize(e.paneContainer,t)}this.hasActiveTextEditor=this.getActiveTextEditor()!=null;this.updateWindowTitle()}getPackageNamesWithActiveGrammars(){const i=[];const n=({includedGrammarScopes:t,packageName:e}={})=>{if(!e){return}if(i.indexOf(e)!==-1){return}i.push(e);for(let e of t!=null?t:[]){n(this.grammarRegistry.grammarForScopeName(e))}};const t=this.getTextEditors();for(let e of t){n(e.getGrammar())}if(t.length>0){for(let e of this.grammarRegistry.getGrammars()){if(e.injectionSelector){n(e)}}}return _.uniq(i)}didActivatePaneContainer(e){if(e!==this.getActivePaneContainer()){this.activePaneContainer=e;this.didChangeActivePaneItem(this.activePaneContainer.getActivePaneItem());this.emitter.emit("did-change-active-pane-container",this.activePaneContainer);this.emitter.emit("did-change-active-pane",this.activePaneContainer.getActivePane());this.emitter.emit("did-change-active-pane-item",this.activePaneContainer.getActivePaneItem())}}didChangeActivePaneOnPaneContainer(e,t){if(e===this.getActivePaneContainer()){this.emitter.emit("did-change-active-pane",t)}}didChangeActivePaneItemOnPaneContainer(e,t){if(e===this.getActivePaneContainer()){this.didChangeActivePaneItem(t);this.emitter.emit("did-change-active-pane-item",t)}if(e===this.getCenter()){const i=this.hasActiveTextEditor;this.hasActiveTextEditor=t instanceof TextEditor;if(this.hasActiveTextEditor||i){const n=this.hasActiveTextEditor?t:undefined;this.emitter.emit("did-change-active-text-editor",n)}}}didChangeActivePaneItem(e){this.updateWindowTitle();this.updateDocumentEdited();if(this.activeItemSubscriptions)this.activeItemSubscriptions.dispose();this.activeItemSubscriptions=new CompositeDisposable;let t,i;if(e!=null&&typeof e.onDidChangeTitle==="function"){i=e.onDidChangeTitle(this.updateWindowTitle)}else if(e!=null&&typeof e.on==="function"){i=e.on("title-changed",this.updateWindowTitle);if(i==null||typeof i.dispose!=="function"){i=new Disposable(()=>{e.off("title-changed",this.updateWindowTitle)})}}if(e!=null&&typeof e.onDidChangeModified==="function"){t=e.onDidChangeModified(this.updateDocumentEdited)}else if(e!=null&&typeof e.on==="function"){t=e.on("modified-status-changed",this.updateDocumentEdited);if(t==null||typeof t.dispose!=="function"){t=new Disposable(()=>{e.off("modified-status-changed",this.updateDocumentEdited)})}}if(i!=null){this.activeItemSubscriptions.add(i)}if(t!=null){this.activeItemSubscriptions.add(t)}this.cancelStoppedChangingActivePaneItemTimeout();this.stoppedChangingActivePaneItemTimeout=setTimeout(()=>{this.stoppedChangingActivePaneItemTimeout=null;this.emitter.emit("did-stop-changing-active-pane-item",e)},STOPPED_CHANGING_ACTIVE_PANE_ITEM_DELAY)}cancelStoppedChangingActivePaneItemTimeout(){if(this.stoppedChangingActivePaneItemTimeout!=null){clearTimeout(this.stoppedChangingActivePaneItemTimeout)}}setDraggingItem(t){_.values(this.paneContainers).forEach(e=>{e.setDraggingItem(t)})}subscribeToAddedItems(){this.onDidAddPaneItem(({item:e,pane:t,index:i})=>{if(e instanceof TextEditor){const n=new CompositeDisposable(this.textEditorRegistry.add(e),this.textEditorRegistry.maintainConfig(e));if(!this.project.findBufferForId(e.buffer.id)){this.project.addBuffer(e.buffer)}e.onDidDestroy(()=>{n.dispose()});this.emitter.emit("did-add-text-editor",{textEditor:e,pane:t,index:i});if(!e.isDestroyed()){n.add(e.observeGrammar(this.handleGrammarUsed.bind(this)))}}})}subscribeToDockToggling(){const e=[this.getLeftDock(),this.getRightDock(),this.getBottomDock()];e.forEach(n=>{n.onDidChangeVisible(e=>{if(e)return;const{activeElement:t}=document;const i=n.getElement();if(i===t||i.contains(t)){this.getCenter().activate()}})})}subscribeToMovedItems(){for(const n of this.getPaneContainers()){n.observePanes(e=>{e.onDidAddItem(({item:t})=>{if(typeof t.getURI==="function"&&this.enablePersistence){const e=t.getURI();if(e){const i=n.getLocation();let e;if(typeof t.getDefaultLocation==="function"){e=t.getDefaultLocation()}e=e||"center";if(i===e){this.itemLocationStore.delete(t.getURI())}else{this.itemLocationStore.save(t.getURI(),i)}}}})})}}updateWindowTitle(){let t,e,i,n;const a=atom.getAppName();const s=this.project.getPaths();const o=s!=null?s:[];const r=this.getActivePaneItem();if(r){t=typeof r.getPath==="function"?r.getPath():undefined;const l=typeof r.getLongTitle==="function"?r.getLongTitle():undefined;e=l==null?typeof r.getTitle==="function"?r.getTitle():undefined:l;i=_.find(o,e=>t===e||(t!=null?t.startsWith(e+path.sep):undefined))}if(e==null){e="untitled"}if(i==null){i=t?path.dirname(t):o[0]}if(i!=null){i=fs.tildify(i)}const c=[];if(r!=null&&i!=null){c.push(e,i);n=t!=null?t:i}else if(i!=null){c.push(i);n=i}else{c.push(e);n=""}if(process.platform!=="darwin"){c.push(a)}document.title=c.join(" â€” ");this.applicationDelegate.setRepresentedFilename(n);this.emitter.emit("did-change-window-title")}updateDocumentEdited(){const e=this.getActivePaneItem();const t=e!=null&&typeof e.isModified==="function"?e.isModified()||false:false;this.applicationDelegate.setWindowDocumentEdited(t)}onDidChangeActivePaneContainer(e){return this.emitter.on("did-change-active-pane-container",e)}observeTextEditors(t){for(let e of this.getTextEditors()){t(e)}return this.onDidAddTextEditor(({textEditor:e})=>t(e))}observePaneItems(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.observePaneItems(t)))}onDidChangeActivePaneItem(e){return this.emitter.on("did-change-active-pane-item",e)}onDidStopChangingActivePaneItem(e){return this.emitter.on("did-stop-changing-active-pane-item",e)}onDidChangeActiveTextEditor(e){return this.emitter.on("did-change-active-text-editor",e)}observeActivePaneItem(e){e(this.getActivePaneItem());return this.onDidChangeActivePaneItem(e)}observeActiveTextEditor(e){e(this.getActiveTextEditor());return this.onDidChangeActiveTextEditor(e)}onDidOpen(e){return this.emitter.on("did-open",e)}onDidAddPane(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.onDidAddPane(t)))}onWillDestroyPane(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.onWillDestroyPane(t)))}onDidDestroyPane(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.onDidDestroyPane(t)))}observePanes(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.observePanes(t)))}onDidChangeActivePane(e){return this.emitter.on("did-change-active-pane",e)}observeActivePane(e){e(this.getActivePane());return this.onDidChangeActivePane(e)}onDidAddPaneItem(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.onDidAddPaneItem(t)))}onWillDestroyPaneItem(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.onWillDestroyPaneItem(t)))}onDidDestroyPaneItem(t){return new CompositeDisposable(...this.getPaneContainers().map(e=>e.onDidDestroyPaneItem(t)))}onDidAddTextEditor(e){return this.emitter.on("did-add-text-editor",e)}onDidChangeWindowTitle(e){return this.emitter.on("did-change-window-title",e)}async open(e,a={}){let s,o;if(typeof e==="string"){s=this.project.resolvePath(e)}else if(e){o=e;if(typeof o.getURI==="function")s=o.getURI()}let t=()=>{};if(s){const i=this.incoming.get(s);if(!i){this.incoming.set(s,new Promise(e=>{t=e}))}else{await i}}try{if(!atom.config.get("core.allowPendingPaneItems")){a.pending=false}if(s&&(!url.parse(s).protocol||process.platform==="win32")){this.applicationDelegate.addRecentDocument(s)}let t,e;if(o||s){if(a.pane){t=a.pane}else if(a.searchAllPanes){t=o?this.paneForItem(o):this.paneForURI(s)}else{let e;if(s)e=this.paneContainerForURI(s);if(!e)e=this.getActivePaneContainer();t=e.getActivePane();switch(a.split){case"left":t=t.findLeftmostSibling();break;case"right":t=t.findRightmostSibling();break;case"up":t=t.findTopmostSibling();break;case"down":t=t.findBottommostSibling();break}}if(t){if(o){e=t.getItems().includes(o)}else{o=t.itemForURI(s);e=o!=null}}}if(o)await Promise.resolve();if(!e){o=o||await this.createItemForURI(s,a);if(!o)return;if(a.pane){t=a.pane}else{let e=a.location;if(!e&&!a.split&&s&&this.enablePersistence){e=await this.itemLocationStore.load(s)}if(!e&&typeof o.getDefaultLocation==="function"){e=o.getDefaultLocation()}const c=typeof o.getAllowedLocations==="function"?o.getAllowedLocations():ALL_LOCATIONS;e=c.includes(e)?e:c[0];const l=this.paneContainers[e]||this.getCenter();t=l.getActivePane();switch(a.split){case"left":t=t.findLeftmostSibling();break;case"right":t=t.findOrCreateRightmostSibling();break;case"up":t=t.findTopmostSibling();break;case"down":t=t.findOrCreateBottommostSibling();break}}}if(!a.pending&&t.getPendingItem()===o){t.clearPendingItem()}this.itemOpened(o);if(a.activateItem===false){t.addItem(o,{pending:a.pending})}else{t.activateItem(o,{pending:a.pending})}if(a.activatePane!==false){t.activate()}let i=0;let n=0;if(!Number.isNaN(a.initialLine)){n=a.initialLine}if(!Number.isNaN(a.initialColumn)){i=a.initialColumn}if(n>=0||i>=0){if(typeof o.setCursorBufferPosition==="function"){o.setCursorBufferPosition([n,i])}if(typeof o.unfoldBufferRow==="function"){o.unfoldBufferRow(n)}if(typeof o.scrollToBufferPosition==="function"){o.scrollToBufferPosition([n,i],{center:true})}}const r=t.getActiveItemIndex();this.emitter.emit("did-open",{uri:s,pane:t,item:o,index:r});if(s){this.incoming.delete(s)}}finally{t()}return o}hide(e){let t=false;for(const i of this.getPaneContainers()){const n=i===this.getCenter();if(n||i.isVisible()){for(const a of i.getPanes()){const s=a.getActiveItem();const o=s!=null&&(s===e||typeof s.getURI==="function"&&s.getURI()===e);if(o){t=true;if(n){a.destroyItem(s)}else{i.hide()}}}}}return t}toggle(e){if(this.hide(e)){return Promise.resolve()}else{return this.open(e,{searchAllPanes:true})}}openLicense(){return this.open(path.join(process.resourcesPath,"LICENSE.md"))}openSync(e="",t={}){const{initialLine:i,initialColumn:n}=t;const a=t.activatePane!=null?t.activatePane:true;const s=t.activateItem!=null?t.activateItem:true;const o=this.project.resolvePath(e);let r=this.getActivePane().itemForURI(o);if(o&&r==null){for(const c of this.getOpeners()){r=c(o,t);if(r)break}}if(r==null){r=this.project.openSync(o,{initialLine:i,initialColumn:n})}if(s){this.getActivePane().activateItem(r)}this.itemOpened(r);if(a){this.getActivePane().activate()}return r}openURIInPane(e,t){return this.open(e,{pane:t})}async createItemForURI(t,e){if(t!=null){for(const i of this.getOpeners()){const n=i(t,e);if(n!=null)return n}}try{const n=await this.openTextFile(t,e);return n}catch(e){switch(e.code){case"CANCELLED":return Promise.resolve();case"EACCES":this.notificationManager.addWarning(`Permission denied '${e.path}'`);return Promise.resolve();case"EPERM":case"EBUSY":case"ENXIO":case"EIO":case"ENOTCONN":case"UNKNOWN":case"ECONNRESET":case"EINVAL":case"EMFILE":case"ENOTDIR":case"EAGAIN":this.notificationManager.addWarning(`Unable to open '${e.path!=null?e.path:t}'`,{detail:e.message});return Promise.resolve();default:throw e}}}async openTextFile(e,t){const i=this.project.resolvePath(e);if(i!=null){try{fs.closeSync(fs.openSync(i,"r"))}catch(e){if(e.code!=="ENOENT"){throw e}}}const n=fs.getSizeSync(i);if(n>=this.config.get("core.warnOnLargeFileLimit")*1048576){await new Promise((i,n)=>{this.applicationDelegate.confirm({message:"Atom will be unresponsive during the loading of very large files.",detail:"Do you still want to load this file?",buttons:["Proceed","Cancel"]},e=>{if(e===1){const t=new Error;t.code="CANCELLED";n(t)}else{i()}})})}const a=await this.project.bufferForPath(i,t);return this.textEditorRegistry.build(Object.assign({buffer:a,autoHeight:false},t))}handleGrammarUsed(e){if(e==null){return}this.packageManager.triggerActivationHook(`${e.scopeName}:root-scope-used`);this.packageManager.triggerActivationHook(`${e.packageName}:grammar-used`)}isTextEditor(e){return e instanceof TextEditor}buildTextEditor(e){const t=this.textEditorRegistry.build(e);const i=this.textEditorRegistry.maintainConfig(t);t.onDidDestroy(()=>i.dispose());return t}reopenItem(){const e=this.destroyedItemURIs.pop();if(e){return this.open(e)}else{return Promise.resolve()}}addOpener(e){this.openers.push(e);return new Disposable(()=>{_.remove(this.openers,e)})}getOpeners(){return this.openers}getPaneItems(){return _.flatten(this.getPaneContainers().map(e=>e.getPaneItems()))}getActivePaneItem(){return this.getActivePaneContainer().getActivePaneItem()}getTextEditors(){return this.getPaneItems().filter(e=>e instanceof TextEditor)}getActiveTextEditor(){const e=this.getCenter().getActivePaneItem();if(e instanceof TextEditor){return e}}saveAll(){this.getPaneContainers().forEach(e=>{e.saveAll()})}confirmClose(t){return Promise.all(this.getPaneContainers().map(e=>e.confirmClose(t))).then(e=>!e.includes(false))}saveActivePaneItem(){return this.getCenter().getActivePane().saveActiveItem()}saveActivePaneItemAs(){this.getCenter().getActivePane().saveActiveItemAs()}destroyActivePaneItem(){return this.getActivePane().destroyActiveItem()}getActivePaneContainer(){return this.activePaneContainer}getPanes(){return _.flatten(this.getPaneContainers().map(e=>e.getPanes()))}getVisiblePanes(){return _.flatten(this.getVisiblePaneContainers().map(e=>e.getPanes()))}getActivePane(){return this.getActivePaneContainer().getActivePane()}activateNextPane(){return this.getActivePaneContainer().activateNextPane()}activatePreviousPane(){return this.getActivePaneContainer().activatePreviousPane()}paneContainerForURI(t){return this.getPaneContainers().find(e=>e.paneForURI(t))}paneContainerForItem(t){return this.getPaneContainers().find(e=>e.paneForItem(t))}paneForURI(t){for(let e of this.getPaneContainers()){const i=e.paneForURI(t);if(i!=null){return i}}}paneForItem(t){for(let e of this.getPaneContainers()){const i=e.paneForItem(t);if(i!=null){return i}}}destroyActivePane(){const e=this.getActivePane();if(e!=null){e.destroy()}}closeActivePaneItemOrEmptyPaneOrWindow(){if(this.getCenter().getActivePaneItem()!=null){this.getCenter().getActivePane().destroyActiveItem()}else if(this.getCenter().getPanes().length>1){this.getCenter().destroyActivePane()}else if(this.config.get("core.closeEmptyWindows")){atom.close()}}increaseFontSize(){this.config.set("editor.fontSize",this.config.get("editor.fontSize")+1)}decreaseFontSize(){const e=this.config.get("editor.fontSize");if(e>1){this.config.set("editor.fontSize",e-1)}}resetFontSize(){this.config.set("editor.fontSize",this.config.get("editor.defaultFontSize"))}itemOpened(e){let t;if(typeof e.getURI==="function"){t=e.getURI()}else if(typeof e.getUri==="function"){t=e.getUri()}if(t!=null){_.remove(this.destroyedItemURIs,t)}}didDestroyPaneItem({item:e}){let t;if(typeof e.getURI==="function"){t=e.getURI()}else if(typeof e.getUri==="function"){t=e.getUri()}if(t!=null){this.destroyedItemURIs.push(t)}}destroyed(){this.paneContainers.center.destroy();this.paneContainers.left.destroy();this.paneContainers.right.destroy();this.paneContainers.bottom.destroy();this.cancelStoppedChangingActivePaneItemTimeout();if(this.activeItemSubscriptions!=null){this.activeItemSubscriptions.dispose()}if(this.element)this.element.destroy()}getCenter(){return this.paneContainers.center}getLeftDock(){return this.paneContainers.left}getRightDock(){return this.paneContainers.right}getBottomDock(){return this.paneContainers.bottom}getPaneContainers(){return[this.paneContainers.center,this.paneContainers.left,this.paneContainers.right,this.paneContainers.bottom]}getVisiblePaneContainers(){const t=this.getCenter();return atom.workspace.getPaneContainers().filter(e=>e===t||e.isVisible())}getBottomPanels(){return this.getPanels("bottom")}addBottomPanel(e){return this.addPanel("bottom",e)}getLeftPanels(){return this.getPanels("left")}addLeftPanel(e){return this.addPanel("left",e)}getRightPanels(){return this.getPanels("right")}addRightPanel(e){return this.addPanel("right",e)}getTopPanels(){return this.getPanels("top")}addTopPanel(e){return this.addPanel("top",e)}getHeaderPanels(){return this.getPanels("header")}addHeaderPanel(e){return this.addPanel("header",e)}getFooterPanels(){return this.getPanels("footer")}addFooterPanel(e){return this.addPanel("footer",e)}getModalPanels(){return this.getPanels("modal")}addModalPanel(e={}){return this.addPanel("modal",e)}panelForItem(t){for(let e in this.panelContainers){const i=this.panelContainers[e];const n=i.panelForItem(t);if(n!=null){return n}}return null}getPanels(e){return this.panelContainers[e].getPanels()}addPanel(e,t){if(t==null){t={}}return this.panelContainers[e].addPanel(new Panel(t,this.viewRegistry))}scan(a,s={},o){if(_.isFunction(s)){o=s;s={}}const i=new Map;for(const n of this.project.getDirectories()){let e=s.ripgrep?this.ripgrepDirectorySearcher:this.scandalDirectorySearcher;for(const d of this.directorySearchers){if(d.canSearchDirectory(n)){e=d;break}}let t=i.get(e);if(!t){t=[];i.set(e,t)}t.push(n)}let r;if(_.isFunction(s.onPathsSearched)){const g=s.onPathsSearched;let n=0;const f=new Map;r=function(e,t){const i=f.get(e);if(i){n-=i}f.set(e,t);n+=t;return g(n)}}else{r=function(){}}const c=[];i.forEach((e,t)=>{const i={inclusions:s.paths||[],includeHidden:true,excludeVcsIgnores:this.config.get("core.excludeVcsIgnoredPaths"),exclusions:this.config.get("core.ignoredNames"),follow:this.config.get("core.followSymlinks"),leadingContextLineCount:s.leadingContextLineCount||0,trailingContextLineCount:s.trailingContextLineCount||0,PCRE2:s.PCRE2,didMatch:e=>{if(!this.project.isPathModified(e.filePath)){return o(e)}},didError(e){return o(null,e)},didSearchPaths(e){return r(t,e)}};const n=t.search(e,a,i);c.push(n)});const l=Promise.all(c);for(let e of this.project.getBuffers()){if(e.isModified()){const p=e.getPath();if(!this.project.contains(p)){continue}var t=[];e.scan(a,e=>t.push(e));if(t.length>0){o({filePath:p,matches:t})}}}let h=false;const e=new Promise((e,t)=>{const i=function(){if(h){e("cancelled")}else{e(null)}};const n=function(e){for(let e of c){e.cancel()}t(e)};l.then(i,n)});e.cancel=()=>{h=true;c.map(e=>e.cancel())};return e}replace(h,d,g,f){return new Promise((e,t)=>{let i;const n=this.project.getBuffers().map(e=>e.getPath());const a=_.difference(g,n);let s=!n.length;let o=!a.length;const r=()=>{if(o&&s){e()}};if(!o.length){let e="g";if(h.multiline){e+="m"}if(h.ignoreCase){e+="i"}const c=Task.once(require.resolve("./replace-handler"),a,h.source,e,d,()=>{o=true;r()});c.on("replace:path-replaced",f);c.on("replace:file-error",e=>{f(null,e)})}for(i of this.project.getBuffers()){if(!g.includes(i.getPath())){continue}const l=i.replace(h,d,f);if(l){f({filePath:i.getPath(),replacements:l})}}s=true;r()})}checkoutHeadRevision(t){if(t.getPath()){const i=async()=>{const e=await this.project.repositoryForDirectory(new Directory(t.getDirectoryPath()));if(e)e.checkoutHeadForEditor(t)};if(this.config.get("editor.confirmCheckoutHeadRevision")){this.applicationDelegate.confirm({message:"Confirm Checkout HEAD Revision",detail:`Are you sure you want to discard all changes to "${t.getFileName()}" since the last Git commit?`,buttons:["OK","Cancel"]},e=>{if(e===0)i()})}else{i()}}}};